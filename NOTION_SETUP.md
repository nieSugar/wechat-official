# Notion 集成设置指南

本指南将帮助你设置 Notion 集成，用于保存微信公众号的用户消息。

## 1. 创建 Notion 集成

### 步骤 1: 创建 Notion 集成
1. 访问 [Notion Integrations](https://www.notion.so/my-integrations)
2. 点击 "New integration"
3. 填写集成信息：
   - **Name**: 微信公众号消息收集器
   - **Logo**: 可选
   - **Associated workspace**: 选择你的工作区
4. 点击 "Submit" 创建集成
5. 复制生成的 **Internal Integration Token**（以 `secret_` 开头）

### 步骤 2: 创建父页面（用于放置数据库）
1. 在 Notion 中创建一个新页面
2. 将页面命名为 "微信公众号数据" 或你喜欢的名称
3. 复制页面 URL 中的页面 ID（32位字符串）
4. 在页面右上角点击 "Share" -> "Invite"，添加你刚创建的集成

### 步骤 3: 自动创建数据库（推荐）
程序提供了自动创建数据库的功能，无需手动配置：

1. 在 `.env` 文件中设置父页面 ID：
   ```env
   NOTION_PARENT_PAGE_ID=你的页面ID
   ```

2. 运行数据库创建脚本：
   ```bash
   npm run create:database
   ```

3. 脚本会自动创建包含所有必要字段的数据库，并显示数据库 ID

4. 将显示的数据库 ID 添加到 `.env` 文件：
   ```env
   NOTION_DATABASE_ID=自动生成的数据库ID
   ```

### 步骤 3 (备选): 手动创建数据库
如果你更喜欢手动创建，请按照以下步骤：

1. 在步骤2创建的页面中添加一个数据库（Database）
2. 将数据库命名为 "微信消息记录"
3. 配置以下数据库属性：

| 属性名称 | 属性类型 | 说明 | 必需 |
|---------|---------|------|------|
| 用户ID | Title | 用户的OpenID | ✅ |
| 消息内容 | Text | 用户发送的消息内容 | ✅ |
| 消息类型 | Select | 消息类型选项 | ✅ |
| AI回复 | Text | AI生成的回复内容 | ✅ |
| 接收时间 | Date | 消息接收时间 | ✅ |
| 状态 | Select | 处理状态选项 | ✅ |
| 来源 | Select | 消息来源选项 | ✅ |
| 用户昵称 | Text | 用户昵称（可选） | ⭕ |
| 消息长度 | Number | 消息字符数 | ⭕ |
| 处理耗时 | Number | AI处理耗时（毫秒） | ⭕ |

#### 消息类型选项配置：
- `text` (文本消息)
- `image` (图片消息)
- `video` (视频消息)
- `voice` (语音消息)
- `location` (位置消息)
- `link` (链接消息)
- `event` (事件消息)

#### 状态选项配置：
- `已处理` (默认)
- `待处理`
- `已忽略`
- `需要人工`

#### 来源选项配置：
- `微信公众号` (默认)
- `微信小程序`
- `网页端`
- `其他渠道`

### 步骤 4: 获取数据库 ID（仅手动创建时需要）
1. 打开你创建的数据库页面
2. 复制页面 URL，格式类似：
   ```
   https://www.notion.so/your-workspace/database-name-32位字符串?v=view-id
   ```
3. 数据库 ID 就是 URL 中的 32 位字符串部分

## 2. 配置环境变量

在项目根目录的 `.env` 文件中添加以下配置：

```env
# Notion 配置
NOTION_TOKEN=your_notion_integration_token_here
NOTION_PARENT_PAGE_ID=your_notion_parent_page_id_here
NOTION_DATABASE_ID=your_notion_database_id_here
```

配置说明：
- `NOTION_TOKEN`: 步骤 1 中获取的集成令牌
- `NOTION_PARENT_PAGE_ID`: 步骤 2 中创建的父页面 ID
- `NOTION_DATABASE_ID`: 自动创建数据库后获得的数据库 ID（或手动创建时获取的 ID）

## 3. 测试连接

启动你的应用程序后，Notion 服务会自动验证连接。查看控制台输出：

- ✅ `Notion连接验证成功` - 表示配置正确
- ❌ `Notion连接验证失败` - 表示配置有问题，请检查令牌和数据库 ID

## 4. 功能说明

### 自动保存消息
当用户向微信公众号发送消息时，系统会自动：
1. 处理消息并生成 AI 回复
2. 将消息信息保存到 Notion 数据库
3. 返回回复给用户

### 数据库记录包含：
- **用户ID**: 用户的微信 OpenID
- **消息内容**: 用户发送的原始消息
- **消息类型**: text/image/video 等
- **AI回复**: 系统生成的回复内容
- **接收时间**: 消息接收的准确时间
- **状态**: 消息处理状态
- **来源**: 消息来源渠道

### 查询功能
你可以使用 Notion 的强大查询功能：
- 按用户 ID 筛选消息
- 按时间范围查看消息
- 按消息类型分类
- 创建自定义视图和报表

## 5. 故障排除

### 常见问题

**问题 1**: `Notion连接验证失败`
- 检查 `NOTION_TOKEN` 是否正确
- 确认令牌以 `secret_` 开头
- 验证集成是否已创建并激活

**问题 2**: `数据库访问被拒绝`
- 确认数据库已授权给集成
- 检查 `NOTION_DATABASE_ID` 是否正确
- 验证数据库 ID 是 32 位字符串

**问题 3**: `属性不匹配`
- 确认数据库属性名称与代码中的完全一致
- 检查属性类型是否正确配置
- 验证 Select 选项是否已创建

**问题 4**: `保存失败但不影响主流程`
- 这是正常的容错机制
- 检查控制台错误日志
- 消息仍会正常回复用户

### 调试技巧
1. 查看控制台日志获取详细错误信息
2. 使用 Notion API 测试工具验证配置
3. 检查网络连接和防火墙设置

## 6. 高级功能

### 统计信息
系统提供了统计功能，可以获取：
- 总消息数量
- 各类型消息分布
- 每日消息统计
- 来源渠道分析

### 自定义扩展
你可以根据需要扩展功能：
- 添加更多消息类型
- 自定义数据库字段
- 实现消息分析和报告
- 集成其他 Notion 功能

## 7. 安全注意事项

1. **保护集成令牌**: 不要将令牌提交到版本控制系统
2. **限制权限**: 只授权必要的数据库访问权限
3. **定期更新**: 定期检查和更新集成配置
4. **监控使用**: 关注 API 使用量和异常访问

---

如有问题，请检查 Notion API 文档或联系技术支持。
